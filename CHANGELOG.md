<!-- @format -->

# CHANGELOG

---

# V2.3.10 (2025-12-08)

**界面间隙优化、命令参数增强与彩蛋修复**
Full Changelog (相对于 2.3.9): <https://github.com/chen6019/Remote-Controls/compare/V2.3.9...V2.3.10>

## 🖥 界面适配

- 主界面系统配置/MQTT认证/主题列表及底部操作区统一内边距，间距一致、更易读。
- 弹窗与窗口尺寸继续使用 DPI 感知缩放（`_scaled_size`），在 125%/150% 等缩放下控件不再拥挤或留白过大。

## ✨ 命令与参数

- 新增 `on#/off#数字(0-100)` 支持，命令模板中的 `{value}` 会替换为该数字，方便亮度/音量等百分比场景传入到 PowerShell/测试命令。
- 输入参数不是整数或超出 0-100 范围时会即时提示并终止执行，避免异常值落地。
- 测试按钮检测到 `{value}` 时弹框询问参数后再运行，减少频繁修改配置的麻烦。

## 🪲 Bug 修复

- 彩蛋随机图片远程地址更新为 `https://rad.spacejoy.top/bz`，确保随机打开不会 404。

## 📖 文档

- README 教程链接与目录结构调整，便于快速定位使用说明。

## ✅ 兼容性

- 配置格式保持兼容，无需迁移；旧配置仍可直接使用。

# V2.3.9 (2025-11-24)

**托盘通知稳定性彻底修复与菜单体验优化**
Full Changelog (相对于 2.3.8): <https://github.com/chen6019/Remote-Controls/compare/V2.3.8...V2.3.9>

## 🐛 核心修复：WinRT 通知崩溃与 CrashSender 错误

- **彻底修复** 在“任务计划程序（最高权限/SYSTEM）”等非交互式或受限会话下，托盘程序尝试发送 Toast 通知导致崩溃的问题。
  - **根因分析**：原逻辑在无法获取 Shell 用户令牌时仍尝试调用 WinRT API，导致底层 `_winrt_windows_data_xml_dom.pyd` 崩溃，进而触发 PyInstaller 的 `CrashSender.exe` 报错。
  - **新策略**：在 `notify` 函数中严格校验用户模拟结果。若无法模拟当前桌面用户（`_impersonate_shell_user` 返回 False），则**直接跳过通知发送并记录警告**，绝对不执行 WinRT 调用，从根本上杜绝崩溃。
- **代码清理**：移除了之前版本为掩盖此问题而添加的 `safe_crash_handler` 装饰器、全局异常钩子及针对 "CrashSender" 字符串的过滤逻辑，代码更加简洁健壮。

## 🔧 功能增强：用户模拟与菜单交互

- **增强用户模拟鲁棒性**：`_impersonate_shell_user` 新增多重查找策略：
  1. 优先尝试 `GetShellWindow`。
  2. 失败则遍历进程列表查找 `explorer.exe`，并优先匹配当前活动控制台会话（Active Console Session）。
  3. 最后兜底使用任意找到的 `explorer.exe`。
  - 这显著提高了在开机自启、多用户或 Shell 重启等复杂场景下成功发送通知的概率。

- **动态托盘菜单**：
  - “退出”菜单项文案现在根据主程序状态动态变化：
    - 主程序运行时显示：“退出托盘（使用主程序自带托盘）”。
    - 主程序未运行时显示：“退出托盘”。
  - **自动刷新**：在主程序启动、重启或关闭后，托盘菜单会自动刷新以即时更新文案。

## ✅ 用户影响

- 使用任务计划开机自启的用户，不再会遇到“打开配置界面”或“点击托盘状态”时程序崩溃的问题。
- 托盘菜单的退出选项语义更加清晰准确。

## 📦 安装包更新

- **安装路径变更**：默认安装路径从 `C:\Program Files (x86)\Remote-Controls` 变更为 `C:\Program Files\Remote-Controls` (64位原生路径)。
- **配置自动迁移**：安装程序会自动检测旧版本配置文件，并将其迁移到新目录，确保用户配置不丢失。
- **卸载优化**：
  - 移除自定义卸载界面，回归原生体验。
  - 卸载时若选择不保留配置文件，将彻底清理安装目录，不残留垃圾文件。

---

# V2.3.8 (2025-11-10)

**完善自定义主题，增加开启/关闭值支持和预设功能**
Full Changelog (相对于 2.3.7): <https://github.com/chen6019/Remote-Controls/compare/V2.3.7...V2.3.8>

## ✨ 新增功能

- 新增自定义主题的开启/关闭值支持：允许为每个自定义主题配置独立的开启和关闭命令值，提升控制灵活性。
- 新增预设功能：支持为自定义主题设置预设值，便于快速应用常用配置。
- 增强GUI界面：为自定义主题添加独立开关控件，支持实时测试功能。

## 🔧 功能增强

- 自定义主题配置界面优化：新增开关状态显示和测试按钮，方便用户验证配置效果。
- 主题值管理改进：支持开启/关闭值的独立配置，避免单一值限制。

## 🐛 修复与优化

- 优化自定义主题的GUI交互逻辑，确保开关和测试功能正常工作。
- 提升配置保存的稳定性，避免因新增字段导致的兼容性问题。

## ✅ 用户影响

- 无需修改现有配置；新增功能向后兼容。
- 自定义主题用户可享受更丰富的控制选项和更好的用户体验。

---

# V2.3.7 (2025-11-09)

**托盘在“任务计划 + 最高权限”场景下的通知稳定性修复**
Full Changelog (相对于 2.3.6: <https://github.com/chen6019/Remote-Controls/compare/V2.3.6...V2.3.7>

## 🐛 关键问题修复

- 修复在“任务计划程序以最高权限运行”场景下，托盘在点击菜单（例如“打开配置界面”“托盘状态”等）触发通知时偶发崩溃并弹出“Error launching CrashSender.exe”的问题。
  - 根因：`win11toast` 依赖的 WinRT 调用在提升会话中由 `winsdk\_winrt.pyd` 原生层崩溃（0xC0000005），Python 无法捕获，最终由 PyInstaller 试图拉起 CrashSender 导致提示。
  - 事件验证：事件查看器显示 Faulting module 指向 `winsdk\_winrt.pyd`，异常码 0xC0000005，与现场一致。

## 🔧 解决方案与实现

- 新增“模拟桌面用户令牌（Impersonation）”机制：
  - 在托盘为管理员权限时，通知线程临时模拟当前登录桌面的 `explorer.exe` 用户令牌，再调用 WinRT 发送 toast，调用完成即恢复线程令牌。
  - 该机制对普通权限运行无影响，仅在提升会话时启用。
- 新增通知熔断保护：
  - 一旦首次通知调用失败（包括 WinRT 初始化失败等），自动禁用本进程后续 toast，改为日志/MessageBox 回退，确保不再被原生崩溃拖垮。

## 🗂 变更范围

- `tray.py`
  - 新增 `_impersonate_shell_user()` 辅助方法（基于 `DuplicateTokenEx` + `SetThreadToken`）。
  - `notify()` 统一通过模拟令牌发送 toast，并内置失败熔断与降级路径。

## ✅ 兼容性与用户影响

- 无需修改任何配置；保留系统通知体验，即便托盘由“任务计划 + 最高权限”启动也不会崩溃。
- 普通权限下行为不变。

## 🔎 建议验证

- 在任务计划程序勾选“使用最高权限运行”，设置登录后触发/开机触发，启动托盘后：
  - 依次点击“托盘状态”“打开配置界面”等，toast 能正常显示，托盘不退出。
  - 如个别环境仍有第一次 toast 失败，后续应用将自动熔断到安全回退，不再崩溃。

---

# V2.3.6 (2025-10-04)

**Hotkey 输入兼容性修复与内部健壮性补丁**  
Full Changelog (相对于 2.3.5): <https://github.com/chen6019/Remote-Controls/compare/V2.3.5...V2.3.6>

## 🐛 核心修复

- 修复自定义 Hotkey 中 `Enter` / `enter` / `RETURN` / `return` 被按字符拆分为 `e n t e r` 逐个输出的问题，现统一识别为一次回车键。
- 修复回车键放在组合的末尾（如 `q+w+e+r+Enter`）时无法触发预期快捷键而变成输入文本的行为。

## 🔧 解析与行为优化

- 新增 `special_single_keys` 功能键白名单，防止 Enter / Esc / Tab / Space / Backspace 等被按字符拆分。
- Hotkey 解析大小写与同义名兼容扩展：`Enter` / `enter` / `RETURN` / `return` → 标准化为 `enter`。
- 保持其它逻辑不变：纯字母串（无 `+`）仍按字符序列依次发送，含 `+` 时仅“字母段”展开；功能键整体发送。

## 🛡 稳定性 & 范围评估

- 修改仅影响 `perform_hotkey` 的组合键执行路径，不触及应用 / 服务 / 命令主题逻辑。
- 回归验证通过：`ctrl+alt+s`、`alt+f4`、`win+e`、`abc`、`a+b+c` 行为均与 2.3.5 一致。
- 对已有配置文件零侵入；无需新增字段或迁移。

## ✅ 建议与指引

- 若之前为绕过问题临时改写 Enter（例如换成 `return` 或手动发送回车脚本），现在可以直接写标准 `Enter`。
- 复杂场景：若需要同时按住 Enter 与其它键，可使用扩展语法 `enter{down}+x+enter{up}`（保持与现有 down/up 语义一致）。

## � 代码实现要点

- 在 `main.py` 的 `perform_hotkey` 内新增 `special_single_keys` 集合，并调整“字母串展开”条件：`key.isalpha() and key not in special_single_keys`。
- 保留已有修饰键排序与显式 `{down}/{up}` 控制逻辑，未改动行为语义。

## �📌 发布类型

小规模补丁版本；针对特定输入法/自动化脚本场景的正确性修复，推荐所有使用回车热键的用户升级。

---

# V2.3.5 (2025-09-27)

**CrashSender错误处理与开机自启稳定性增强**

## 🛡️ CrashSender错误专项处理

- **新增** 智能CrashSender错误检测与忽略机制：新增 `@safe_crash_handler` 装饰器，自动识别并安全忽略所有CrashSender相关错误
- **新增** 多级错误检测算法：支持检测 `crashsender`、`crash sender`、`crash-sender` 等多种错误变体
- **新增** 函数级异常保护：为所有托盘菜单相关函数添加异常处理装饰器

## ⚡ 开机自启稳定性增强

- **新增** 启动时间检测机制：智能识别开机自启场景（启动后60秒内）
- **新增** 开机自启延迟保护：检测到开机自启时，主程序初始化延迟5秒执行
- **新增** 点击事件节流保护：开机后30秒内，托盘菜单点击操作添加0.5秒延迟

## 🔧 程序稳定性优化

- **新增** 托盘图标运行时专门错误处理：增强 `icon.run()` 的异常捕获
- **新增** 详细的错误上下文日志：记录异常发生的函数名称、错误类型、完整堆栈信息
- **新增** 带返回结果的启动函数：优化主程序启动流程，确保启动状态可追踪
- **新增** 延迟通知机制：主程序完全启动后才发送通知，避免启动过程中的通知显示问题
- **优化** 用户通知机制：CrashSender错误显示为警告通知而非错误通知

## 🐛 主要问题修复

- **修复** 开机自启后点击"托盘状态"触发"Error launching CrashSender.exe"错误导致托盘进程终止的问题
- **修复** 系统启动初期资源紧张时的程序崩溃问题
- **修复** 外部crash报告机制触发的异常未捕获问题

## ✅ 用户影响

- **零配置**：完全向后兼容，无需修改任何用户配置
- **零学习成本**：所有错误处理在后台自动进行
- **建议更新**：强烈推荐更新到此版本，获得更稳定的开机自启体验

---

# V2.3.4 (2025-09-15)

**弱网/兼容性修复与启动稳定性改进**

## 🔧 关键修复

- 修复在无网络或 DNS 解析失败时程序直接退出的问题：连接流程改为异步 `connect_async` + 后台循环 `loop_start()`，并增加自动重连退避（2s-30s），弱网场景下程序将持续重试并以替换式通知提示状态，网络恢复后自动清除提示。
- 修复 paho-mqtt 回调签名兼容性问题：调整 `on_disconnect` 回调为 v2 签名以避免运行时参数错误导致崩溃。
- 修复客户端 ID 类型问题：确保传入 `Client._client_id` 的为 `bytes`（对字符串进行 UTF-8 编码），避免库内部重复 `.decode()` 导致异常。
- 增强消息处理健壮性：`on_message` 现在兼容 `bytes` 与 `str` payload，解码使用 `utf-8` 并容错，单条消息异常不会导致主进程退出。

## 🛡 影响范围

- 主程序（`RC-main`）启动与网络稳定性相关逻辑被加固；托盘与 GUI 行为保持不变。
- 仅修复兼容性/健壮性问题，无新增功能或行为改变。

## ✅ 建议验证步骤

- 正常网络启动：程序应常驻并自动订阅主题，通知中心仅短暂显示“正在连接…”并在成功后自动清除。
- 无网络启动：程序不应退出，会显示替换式“正在重试”通知；恢复网络后提示自动消失并继续正常工作。

---

# V2.3.2 (2025-09-03)

**稳定性加固与打包精简**  
**Full Changelog**: <https://github.com/chen6019/Remote-Controls/compare/V2.3.1...V2.3.2>

## 🛡 稳定性 / 崩溃防护

- 新增全局 `sys.excepthook` 安全捕获：记录未捕获异常并以通知提示，避免 PyInstaller 某些环境弹出 *CrashSender.exe* 报错窗口导致托盘闪退。
- 托盘“托盘状态”动作改为异步线程 + ShellExecuteW 打开浏览器，降低同步调用造成的阻塞和偶发崩溃概率（线程内多层 try/except 防御）。
- 增加 1 秒节流，防止用户快速连点触发多重浏览器启动造成资源竞争。

## 🌐 浏览器调用逻辑调整

- 统一使用 `ShellExecuteW('open', url)` 优先方案，失败再回退 `webbrowser.open`，提升与默认浏览器/多浏览器管理器兼容性。
- 移除窗口句柄/模拟 F5 刷新方案，避免聚焦/刷新错误标签页的副作用（忽略“刷新同标签”改为明确新开或直接聚焦交由浏览器处理）。

## 🧹 打包脚本与资源

- PyInstaller / Nuitka 打包脚本移除对本地彩蛋图片 (cd1~cd5) 的收集与捆绑逻辑，减小构建体积 & 降低差异变更导致的打包失败风险。
- `tray.py` 头部打包说明同步：当前仅需 `icon.ico`。

## 🔔 通知与可用性

- “随机图片”动作统一通知文案：失败/过快/成功三态明确区分，替换式通知避免刷屏。

## 🛠 代码健壮性

- 网络 / 打开浏览器链路分段捕获异常，确保失败不会传播到主消息循环。
- 去除无用的本地回退路径与冗余扫描逻辑，减少 I/O。

## 📦 影响范围

- 主程序及 GUI 行为未改动（与 2.3.1 保持一致）。
- 仅托盘与打包脚本发生差异；更新后无需额外迁移或清理操作。

> 注：本次版本按要求忽略“彩蛋”相关历史改动，不计入变更点。

# V2.3.1 (2025-08-29)

**托盘交互与通知系统实时性强化**  
Full Changelog: <https://github.com/chen6019/Remote-Controls/compare/V2.3.0...V2.3.1>

## 🛎 通知系统重构（低延迟）

- 自定义应用名称：主程序与托盘分别显示为“远程控制主程序 / 托盘”，不再是默认 Python。
- 新增图标自适应：自动生成 64×64 透明留白缩放 PNG，避免系统裁剪导致图标被放大截断。
- 通知模式支持：
  - replace（默认）：使用固定 tag/group 覆盖上一条，实现“状态面板式”实时刷新，不等待旧通知消失。
  - stack：保留原叠加显示方式（需要时显式传入 `mode="stack"`）。
- 加入唯一 tag 逻辑与 fallback，兼容不同版本 `win11toast` 参数（title/body/app_id/icon）。
- 失败降级：参数不兼容/图标异常时自动回退最简通知，保证不中断。

## 🧊 托盘交互与菜单体验

- 取消单击托盘图标直接打开 GUI（防止误触）；改为仅通过菜单项“打开配置界面”显式触发。
- 初始尝试的“双击打开”方案撤销，逻辑更直观、可控。
- 脚本模式下新增只读菜单项提示“当前运行方式：脚本模式”，打包版自动隐藏该项。
- 退出托盘逻辑优化：若主程序未运行则直接退出托盘，不再强制启动/重启主程序。

## 🔔 使用场景改进

- 高频状态推送（下载进度 / 在线心跳 / 任务切换）可即时覆盖，不堆积历史通知，提升有效信息密度。
- 图标尺寸规范化后在 Windows 11 通知中心展示更干净，品牌识别一致。

## 🐞 修复 & 稳定性

- 修复早前编辑中遗失的 `close_exe` / `close_script` 方法，恢复进程关闭能力。
- 修复托盘菜单逻辑残留缩进/错位代码片段导致的潜在语法异常。
- 通知封装加入多层 try/except，避免单点失败中断业务线程。

## ⚙️ 开发维护

- 通知封装集中缓存缩放图标，避免重复磁盘 I/O。
- 统一主/托盘两处封装接口参数（message / mode / unique / icon 自动处理）。

---

# V2.3.0 (2025-08-22)

**单实例与脚本模式体验重构**  
Full Changelog: <https://github.com/chen6019/Remote-Controls/compare/V2.2.13...V2.3.0>

## 🔐 单实例 / 互斥体机制

- 新增“互斥体 + 进程枚举”双重校验：仅当真实存在其它运行实例才阻止启动，避免异常退出留下残留互斥体导致误报。
- 脚本模式出现冲突时提供三选项原生对话框：
  - 是：尝试终止其它实例后继续启动。
  - 否：忽略互斥体直接继续（允许多开，记录警告日志）。
  - 取消：安全退出。
- 结束其它实例时：逐个发送 terminate，等待最多 3 秒；仍存活则提示并终止当前启动，防止不确定状态。
- 仅检测到“残留互斥体”且无其它实例时自动继续，并写入警告日志以便诊断。
- 交互降级：若图形对话框创建失败，回退到原简单提示并退出，保证一致的安全行为。

## 🖥️ 控制台与提权一致性

- 统一 `main.py` / `tray.py` / `GUI.py` 脚本模式启动自动隐藏控制台；设置环境变量 `RC_NO_HIDE=1` 可取消隐藏（便于调试）。
- 提权重启逻辑重写：使用 `ShellExecuteW(runas)` 直接调用本虚拟环境 `pythonw`（可回退到 `python`），避免附带旧控制台窗口。
- 启动提权副本后循环检测新进程是否出现，再退出旧进程，减少用户感知到的“闪退”或空白时间。

## ⚙️ 稳定性 & 维护

- 避免因孤立互斥体阻塞启动，提升异常恢复能力。
- 多开 / 强制继续 / 终止其它实例的每一种路径都会记录清晰日志，便于线上问题复盘。
- 逻辑同时兼容脚本模式与打包为 EXE 的运行场景；不影响现有 CI / 安装器流程。

## 📦 版本与构建

- 延续 2.2.13 引入的“完全动态版本”机制，2.3.0 无需新增硬编码或额外构建步骤。
- 版本信息仍集中于 `version_info.py`，安装器通过临时脚本注入版本保持一致性。

## 🪄 用户可感知改进

- 明显减少“程序已在运行”误报场景。
- 赋予用户可控的实例冲突处理选项，提升容错与自救能力。
- 提权 / 重启流程更加平滑，避免界面闪烁与不确定等待。

---

# V2.2.13 (2025-08-22)

**动态版本管理与安装器修复**

## 🔧 安装器修复

- 修复安装时误报“检测到程序正在运行”的问题，重构进程检测机制，使用 `tasklist` + `findstr` 精确检测。
- 改进安装前的进程检查逻辑，减少不必要的用户干预，确保安装流程的准确性和用户友好性。

## 🚀 完全动态版本管理

- Inno Setup 脚本动态化：移除硬编码版本号，打包时自动生成临时脚本注入当前版本信息。
- 智能版本检测：优先使用命令行参数指定版本，未指定时读取 `version_info.py`，最后兜底 `0.0.0`。
- 文件管理优化：构建过程中自动创建和清理临时文件，新增 `.gitignore` 规则排除临时构建文件，避免源文件被修改。

## 📋 技术实现详情

- 临时文件策略：动态生成 `Remote-Controls-temp.iss`，构建完成后自动清理。
- 版本传递机制：打包脚本从 `version_info.py` 提取版本号，插入 Inno Setup 脚本顶部，确保构建产物版本一致。

## 🎯 构建流程改进

- 打包过程不再修改任何源代码文件。
- GitHub Actions 与本地构建流程完全兼容。
- 构建失败时改进错误提示和清理机制。

---

# V2.2.12 (2025-08-22)

**托盘菜单动态更新与用户体验提升**

## 🔄 动态托盘菜单

- 实时版本状态显示：托盘版本菜单动态显示“检查中 / 发现新版本 / 已是最新 / 检查失败”。
- 版本检查缓存系统：新增 `_version_check_cache` 存储状态、最新版本号与时间戳，减少重复网络请求。

## 🎯 用户体验优化

- 点击版本菜单后立即打开项目主页，检查在后台异步进行。
- 菜单文本根据缓存状态智能显示，包括“未知版本”特殊处理。

## 📱 界面改进

- 菜单文本根据不同状态显示相应版本信息。
- 改进版本比较逻辑，准确显示版本关系，统一菜单显示格式。

---

# V2.2.11 (2025-08-22)

**启动日志与程序信息记录**

## 📝 启动日志增强

- `main.py` 记录程序版本、运行模式、启动时间、Python 版本、系统信息和工作目录。
- 脚本模式与 EXE 模式分别记录解释器/可执行文件信息；测试模式提供专门标识。

## 🛠️ 系统信息记录

- 自动记录操作系统版本、架构、运行用户和权限状态。
- 统一使用 `version_info.py` 读取版本，提供未知版本回退显示。

## 🔍 调试支持

- 记录程序各初始化阶段详细信息，提供启动性能与状态监控数据，便于诊断。

---

# V2.2.10 (2025-08-21)

**版本管理系统重构与源码清理**

## 🏗️ 版本管理系统重构

- 所有源文件移除硬编码版本号，统一使用 `version_info.py`。
- 版本获取失败时显示 “V 未知版本”，避免程序崩溃。
- 打包脚本示例版本号改为通用“1.0.0”，新增 `VERSION_GUIDE.md`。

## 🔧 版本比较逻辑优化

- 修复托盘程序“V 未知版本”与远程版本比较逻辑。
- 当本地版本未知时提示可更新，改进 `_compare_versions()` 异常处理。

## 📋 配置文件管理

- 所有组件统一从 `version_info.py` 读取版本。
- 版本文件缺失或损坏时提供回退策略，确保程序在异常时仍可运行。

## 🎯 开发体验改进

- 开发者只需修改 `version_info.py` 一个文件，打包时自动同步，避免版本不一致。

---

# V2.2.9 (2025-08-20)

**GitHub Actions 版本更新功能测试**

## 🧪 测试目的

- 验证标签重复构建的更新日志合并。
- 确认 CI/CD 流程在不同场景下的稳定性。
- 测试版本检测、历史日志提取和内容合并流程。

## 🔍 新增功能验证

- 自动识别同标签重复构建并保留历史内容。
- Release 提取历史更新内容，保持版本时间线连续。
- 合并当前构建更新与历史内容，提供清晰变更记录。

## 📊 测试范围

- 测试标签触发与手动触发。
- 确认 Windows + Python 3.12.10 构建环境稳定。
- 验证可执行文件生成与发布流程完整性。

## 🎯 预期结果

- Actions 正确识别版本状态并调整更新日志策略。
- 重复版本构建保留完整历史信息。
- 用户能获得完整的版本变更历史与构建信息。

---

# V2.2.8 (2025-08-20)

**GitHub Actions 集成与 CI/CD 自动化**

## 🚀 CI/CD 自动化

- 新增 `build-and-release.yml` 工作流，支持标签和手动触发。
- Windows 运行器 + Python 3.12.10 构建环境。
- 集成 PyInstaller 主构建（Nuitka 备用），自动从标签提取版本号。

## 🛠️ 双打包系统集成

- 统一输出目录 `installer/dist/`，确保关键产物存在。
- 构建过程中验证依赖、列出产物并上传。

## 🔗 相关改进

- 构建脚本自动更新 `version_info.py`，确保版本一致。
- Actions 日志包含详细依赖检查、构建验证与错误输出，便于排查。

---
