# @format

name: Build and Release Remote Controls

on:
    # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ V2.2.8ï¼‰
    push:
        tags:
            - "V*.*.*.*"
            - "V*.*.*"
            - "V*"

    # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆç”¨äºæµ‹è¯•ï¼‰
    workflow_dispatch:
        inputs:
            version:
                description: "ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š2.2.8ï¼‰"
                required: true
                default: "2.2.8"
                type: string
            update_version_files:
                description: "æ˜¯å¦æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶"
                required: false
                default: true
                type: boolean

env:
    PYTHON_VERSION: "3.12.10"
    # è®¾ç½®UTF-8ç¼–ç ä»¥æ­£ç¡®å¤„ç†ä¸­æ–‡å­—ç¬¦
    PYTHONIOENCODING: "utf-8"
    PYTHONUTF8: "1"

jobs:
    build-and-release:
        runs-on: windows-latest
        permissions:
            contents: write
            actions: read
            issues: read
            pull-requests: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
              
            - name: Install Inno Setup 6
              run: |
                Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "is.exe"
                Start-Process -FilePath "is.exe" -ArgumentList "/VERYSILENT /NORESTART" -Wait
              shell: pwsh

            - name: Extract version from tag or input
              id: version
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  if ("${{ github.event_name }}" -eq "push") {
                    # ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ V å‰ç¼€ï¼‰
                    $tagName = "${{ github.ref_name }}"
                    $version = $tagName -replace '^V', ''
                    echo "version=$version" >> $env:GITHUB_OUTPUT
                    echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
                    echo "is_tag_push=true" >> $env:GITHUB_OUTPUT
                  } else {
                    # æ‰‹åŠ¨è§¦å‘ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
                    $version = "${{ github.event.inputs.version }}"
                    $tagName = "V$version"
                    echo "version=$version" >> $env:GITHUB_OUTPUT
                    echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
                    echo "is_tag_push=false" >> $env:GITHUB_OUTPUT
                  }
                  echo "æ„å»ºç‰ˆæœ¬: $version"
                  echo "æ ‡ç­¾åç§°: $tagName"

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Create virtual environment
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  python -m venv .venv
                  .\.venv\Scripts\Activate.ps1
                  python -m pip install --upgrade pip setuptools wheel

            - name: Install dependencies
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  .\.venv\Scripts\Activate.ps1

                  # å¼ºåˆ¶é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–
                  pip install --upgrade pip setuptools wheel

                  echo "=== å®‰è£…ä¸»è¦ä¾èµ– ==="
                  # é¦–å…ˆå°è¯•ä»requirements.txtå®‰è£…
                  pip install -r requirements.txt --force-reinstall

                  # å¦‚æœrequirements.txtå®‰è£…å¤±è´¥ï¼Œæ‰‹åŠ¨å®‰è£…å…³é”®ä¾èµ–
                  echo "=== ç¡®ä¿å…³é”®ä¾èµ–å·²å®‰è£… ==="
                  pip install paho-mqtt>=2.1.0 --upgrade
                  pip install pystray>=0.19.5 --upgrade  
                  pip install pywin32>=310 --upgrade
                  pip install psutil>=7.0.0 --upgrade
                  pip install pillow>=11.2.1 --upgrade
                  pip install win11toast>=0.35 --upgrade
                  pip install pyautogui>=0.9.54 --upgrade
                  pip install wmi>=1.5.1 --upgrade
                  pip install comtypes>=1.4.10 --upgrade
                  pip install pycaw>=20240210 --upgrade

                  pip install pyinstaller>=6.13.0
                  # pip install nuitka>=2.7.12 zstandard>=0.24.0  # å·²ç¦ç”¨Nuitkaæ„å»º

                  # éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
                  echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
                  python -c "import pystray; print('pystray version:', pystray.__version__)"
                  python -c "import paho.mqtt.client as mqtt; print('paho-mqtt: OK')"
                  python -c "import win32com.client; print('pywin32: OK')"
                  python -c "import tkinter; print('tkinter: OK')"
                  python -c "import psutil; print('psutil: OK')"
                  python -c "import PIL; print('Pillow: OK')"

                  echo "=== å·²å®‰è£…çš„åŒ… ==="
                  pip list | Select-String -Pattern "pystray|paho|pywin32|pillow|psutil|win11toast"

            - name: Update version files
              if: ${{ github.event.inputs.update_version_files == 'true' || github.event_name == 'push' }}
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
                  LC_ALL: en_US.UTF-8
                  LANG: en_US.UTF-8
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"

                  .\.venv\Scripts\Activate.ps1
                  $version = "${{ steps.version.outputs.version }}"

                  # æ‰§è¡Œå‰å†æ¬¡ç¡®è®¤ç¼–ç è®¾ç½®
                  python -c "import sys; print('Python encoding:', sys.stdout.encoding)"

                  python installer/update_version.py $version
                  echo "ç‰ˆæœ¬æ–‡ä»¶å·²æ›´æ–°åˆ°: $version"

            - name: Test source files
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"

                  .\.venv\Scripts\Activate.ps1

                  echo "=== éªŒè¯Pythonç¯å¢ƒ ==="
                  python --version
                  python -c "import sys; print('Python path:', sys.executable)"

                  echo "=== éªŒè¯å…³é”®ä¾èµ– ==="
                  $failed = $false

                  try { python -c "import pystray; print('âœ“ pystray: OK')" } catch { echo "âœ— pystray: MISSING"; $failed = $true }
                  try { python -c "import paho.mqtt.client as mqtt; print('âœ“ paho-mqtt: OK')" } catch { echo "âœ— paho-mqtt: MISSING"; $failed = $true }
                  try { python -c "import win32com.client; print('âœ“ pywin32: OK')" } catch { echo "âœ— pywin32: MISSING"; $failed = $true }
                  try { python -c "import psutil; print('âœ“ psutil: OK')" } catch { echo "âœ— psutil: MISSING"; $failed = $true }
                  try { python -c "import PIL; print('âœ“ Pillow: OK')" } catch { echo "âœ— Pillow: MISSING"; $failed = $true }

                  if ($failed) {
                    echo "âŒ å…³é”®ä¾èµ–ç¼ºå¤±ï¼Œåœæ­¢æ„å»º"
                    exit 1
                  }

                  echo "âœ… å…³é”®ä¾èµ–éªŒè¯é€šè¿‡ï¼Œè·³è¿‡æºæ–‡ä»¶å¯¼å…¥æµ‹è¯•ï¼ˆPyInstalleræ„å»ºæ—¶ä¼šè‡ªåŠ¨éªŒè¯ï¼‰"

            - name: Build with PyInstaller
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
                  LC_ALL: en_US.UTF-8
                  LANG: en_US.UTF-8
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"

                  .\.venv\Scripts\Activate.ps1
                  $version = "${{ steps.version.outputs.version }}"

                  # è¿è¡ŒPyInstalleræ„å»ºè„šæœ¬
                  echo "å¼€å§‹PyInstalleræ„å»º..."
                  try {
                    pwsh -NoProfile -ExecutionPolicy Bypass -File installer/build_installer.ps1 $version
                    echo "âœ… PyInstalleræ„å»ºå®Œæˆ"
                  } catch {
                    echo "âŒ PyInstalleræ„å»ºå¤±è´¥: $_"
                    exit 1
                  }

                  # éªŒè¯æ„å»ºäº§ç‰©
                  if (Test-Path "installer/dist") {
                    echo "=== æ„å»ºäº§ç‰© ==="
                    Get-ChildItem -Path "installer/dist" -Recurse | ForEach-Object { echo $_.FullName }
                    
                    # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                    $requiredFiles = @("RC-main.exe", "RC-GUI.exe", "RC-tray.exe")
                    $missingFiles = @()
                    foreach ($file in $requiredFiles) {
                      if (!(Test-Path "installer/dist/$file")) {
                        $missingFiles += $file
                      }
                    }
                    
                    if ($missingFiles.Count -gt 0) {
                      echo "âŒ ç¼ºå°‘å…³é”®æ–‡ä»¶: $($missingFiles -join ', ')"
                      exit 1
                    } else {
                      echo "âœ… æ‰€æœ‰å…³é”®æ–‡ä»¶æ„å»ºæˆåŠŸ"
                    }
                  } else {
                    echo "âŒ æ„å»ºè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
                    exit 1
                  }

            - name: Build with Nuitka (backup)
              if: false # ç¦ç”¨Nuitkaæ„å»ºï¼Œä»…ä½¿ç”¨PyInstaller
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
                  LC_ALL: en_US.UTF-8
                  LANG: en_US.UTF-8
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"

                  .\.venv\Scripts\Activate.ps1
                  $version = "${{ steps.version.outputs.version }}"

                  # è¿è¡ŒNuitkaæ„å»ºè„šæœ¬ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
                  try {
                    pwsh -NoProfile -ExecutionPolicy Bypass -File installer/build_nuitka.ps1 $version
                    echo "Nuitkaæ„å»ºå®Œæˆ"
                  } catch {
                    echo "Nuitkaæ„å»ºå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨PyInstallerç‰ˆæœ¬: $_"
                  }

            - name: List build artifacts
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
                  if (Test-Path "installer/dist") {
                    echo "EXEæ–‡ä»¶:"
                    Get-ChildItem -Path "installer/dist" -Filter "*.exe" | ForEach-Object { 
                      echo "  $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
                    }
                    
                    echo "å®‰è£…åŒ…:"
                    Get-ChildItem -Path "installer/dist/installer" -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
                      echo "  $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
                    }
                  }

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: remote-controls-v${{ steps.version.outputs.version }}
                  path: |
                      installer/dist/*.exe
                      installer/dist/installer/*.exe
                  retention-days: 90

            - name: Generate changelog
              id: changelog
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  $version = "${{ steps.version.outputs.version }}"
                  $tagName = "${{ steps.version.outputs.tag_name }}"

                  # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
                  $previousTag = ""
                  try {
                    $tags = git tag --sort=-version:refname | Select-Object -First 2
                    if ($tags.Count -gt 1) {
                      $previousTag = $tags[1]
                    } else {
                      $previousTag = git rev-list --max-parents=0 HEAD
                    }
                  } catch {
                    $previousTag = "HEAD~10"
                  }

                  echo "å½“å‰æ ‡ç­¾: $tagName"
                  echo "ä¸Šä¸€ä¸ªæ ‡ç­¾: $previousTag"

                  # æ£€æŸ¥æ˜¯å¦ä¸ºåŒç‰ˆæœ¬é‡å¤æ„å»º
                  $isRepeatVersion = $false
                  $existingRelease = ""
                  try {
                    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡ç­¾çš„Release
                    $releaseInfo = gh release view $tagName --json body,createdAt 2>$null
                    if ($releaseInfo) {
                      $isRepeatVersion = $true
                      $existingRelease = ($releaseInfo | ConvertFrom-Json).body
                      echo "æ£€æµ‹åˆ°é‡å¤ç‰ˆæœ¬: $tagNameï¼Œå°†åˆå¹¶æ›´æ–°æ—¥å¿—"
                    }
                  } catch {
                    echo "æœªæ‰¾åˆ°ç°æœ‰Releaseï¼Œåˆ›å»ºæ–°çš„æ›´æ–°æ—¥å¿—"
                  }

                  # ä¼˜å…ˆä» CHANGELOG.md æå–ç‰ˆæœ¬æ›´æ–°å†…å®¹
                  $changelogContent = ""
                  try {
                    if (Test-Path 'CHANGELOG.md') {
                      $changelogFile = Get-Content 'CHANGELOG.md' -Raw
                      # åŒ¹é…ä»¥ "# V<version>" å¼€å¤´ç›´åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜æˆ–æ–‡ä»¶ç»“å°¾
                      $escapedVersion = [regex]::Escape($version)
                      $pattern = "(?ms)^#\s*V$escapedVersion\b[\s\S]*?(?=^#\s*V\d+\.\d+\.\d+\b|\Z)"
                      $match = [regex]::Match($changelogFile, $pattern)
                      
                      # å¦‚æœç®€å•æ¨¡å¼ä¸åŒ¹é…ï¼Œå°è¯•åŒ…å«æ—¥æœŸçš„å®Œæ•´æ¨¡å¼
                      if (-not $match.Success) {
                        $pattern = "(?ms)^#\s*V$escapedVersion\s*\([\d-]+\)[\s\S]*?(?=^#\s*V\d+\.\d+\.\d+\s*\(|\Z)"
                        $match = [regex]::Match($changelogFile, $pattern)
                      }
                      if ($match.Success) {
                        $section = $match.Value.Trim()
                        # å»æ‰ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼ˆ# Vx.y.z ...ï¼‰
                        $lines = $section -split "`n"
                        if ($lines.Length -gt 1) {
                          $body = ($lines | Select-Object -Skip 1) -join "`n"
                        } else { $body = $section }
                        $body = $body.Trim()
                        if ($body) {
                          echo "å·²ä» CHANGELOG.md æå–ç‰ˆæœ¬æ›´æ–°å†…å®¹"
                          $changelogContent = $body
                        }
                      }
                    }
                  } catch {
                    echo "ä» CHANGELOG.md æå–å†…å®¹å¤±è´¥: $_"
                  }

                  if (-not $changelogContent) {
                    echo "æœªåœ¨ CHANGELOG.md ä¸­æ‰¾åˆ°ç‰ˆæœ¬ $version çš„æ®µè½ï¼Œåç»­å°†ä½¿ç”¨æäº¤è®°å½•ç”Ÿæˆæ›´æ–°å†…å®¹"
                  }

                  # å¦‚æœè¿˜æ˜¯æ²¡æœ‰å†…å®¹ï¼Œç”Ÿæˆcommitæ—¥å¿—
                  if (-not $changelogContent) {
                    $commitLog = ""
                    if ($previousTag -ne "") {
                      if ($isRepeatVersion) {
                        # é‡å¤ç‰ˆæœ¬ï¼šè·å–æ›´å¹¿æ³›çš„commitå†å²
                        echo "ä½¿ç”¨æ‰©å±•çš„commitå†å²"
                        $commits = git log --pretty=format:"- %s (%h)" "HEAD~20..HEAD" | Where-Object { $_ -ne "" }
                      } else {
                        # æ–°ç‰ˆæœ¬ï¼šè·å–ä¸ä¸Šä¸€ä¸ªæ ‡ç­¾çš„å·®å¼‚
                        $commits = git log --pretty=format:"- %s (%h)" "$previousTag..HEAD" | Where-Object { $_ -ne "" }
                      }
                      
                      if ($commits) {
                        $commitLog = $commits -join "`n"
                      }
                    }

                    # å¦‚æœæ²¡æœ‰commitå˜æ›´ï¼Œæ·»åŠ é»˜è®¤è¯´æ˜
                    if (-not $commitLog) {
                      if ($isRepeatVersion) {
                        $commitLog = "- é‡æ–°æ„å»ºå’Œå‘å¸ƒä¼˜åŒ–`n- ä¿®å¤æ„å»ºæµç¨‹å’Œä¾èµ–é—®é¢˜"
                      } else {
                        $commitLog = "- ç‰ˆæœ¬å‘å¸ƒå’Œæ„å»ºä¼˜åŒ–"
                      }
                    }
                    $changelogContent = $commitLog
                  }

                  # å¤„ç†é‡å¤ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—åˆå¹¶
                  $versionNote = ""
                  if ($isRepeatVersion) {
                    $versionNote = "ğŸ” é‡æ–°æ„å»ºå‘å¸ƒ - $(Get-Date -Format 'yyyy-MM-dd HH:mm') UTC`n`næ­¤ç‰ˆæœ¬åŒ…å«ä¹‹å‰å‘å¸ƒçš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¿®å¤äº†æ„å»ºæµç¨‹é—®é¢˜ã€‚`n"
                    
                    # å°è¯•ä»ç°æœ‰Releaseä¸­æå–ä¹‹å‰çš„æ›´æ–°å†…å®¹
                    if ($existingRelease -and $existingRelease.Contains("### ğŸ”„ æ›´æ–°å†…å®¹")) {
                      $previousContent = $existingRelease -split "### ğŸ”„ æ›´æ–°å†…å®¹"
                      if ($previousContent.Length -gt 1) {
                        $previousUpdates = ($previousContent[1] -split "### ğŸ“š ç›¸å…³é“¾æ¥")[0].Trim()
                        if ($previousUpdates) {
                          $changelogContent = "**æœ¬æ¬¡é‡æ–°æ„å»ºçš„æ›´æ–°ï¼š**`n$changelogContent`n`n**ä¹‹å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹ï¼š**`n$previousUpdates"
                        }
                      }
                    }
                  } else {
                    $versionNote = "ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ - $(Get-Date -Format 'yyyy-MM-dd HH:mm') UTC"
                  }

                  # ç”Ÿæˆæœ€ç»ˆæ›´æ–°æ—¥å¿—å†…å®¹
                  try {
                    # ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿Here-Stringä»¥é¿å…YAMLè§£æé—®é¢˜
                    $finalChangelog = "$versionNote`n`n### ğŸ”„ æ›´æ–°å†…å®¹`n$changelogContent`n`n### ğŸ“š ç›¸å…³é“¾æ¥`n- [ğŸ“– é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)`n- [ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)`n- [ğŸ’¾ å†å²ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases)"

                    echo "ğŸ“„ ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—å†…å®¹é•¿åº¦: $($finalChangelog.Length) å­—ç¬¦"
                    
                    # éªŒè¯GITHUB_OUTPUTç¯å¢ƒå˜é‡
                    if (-not $env:GITHUB_OUTPUT) {
                      echo "âŒ GITHUB_OUTPUTç¯å¢ƒå˜é‡æœªè®¾ç½®"
                      exit 1
                    }
                    echo "ğŸ“ GITHUB_OUTPUTè·¯å¾„: $($env:GITHUB_OUTPUT)"

                    # å°†å†…å®¹å†™å…¥GitHubè¾“å‡ºï¼ˆå¤„ç†å¤šè¡Œå†…å®¹ï¼‰
                    $delimiter = "EOF_$(Get-Random)"
                    # ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿Here-Stringä»¥é¿å…YAMLè§£æé—®é¢˜
                    $outputContent = "changelog<<$delimiter`n$finalChangelog`n$delimiter"
                    $outputContent | Add-Content -Path $env:GITHUB_OUTPUT -Encoding UTF8
                    
                    # éªŒè¯è¾“å‡ºæ˜¯å¦æˆåŠŸå†™å…¥
                    if (Test-Path $env:GITHUB_OUTPUT) {
                      $fileContent = Get-Content $env:GITHUB_OUTPUT -Raw
                      echo "âœ… GitHubè¾“å‡ºå†™å…¥æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: $($fileContent.Length) å­—ç¬¦"
                    } else {
                      echo "âŒ GitHubè¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨"
                      exit 1
                    }
                    
                  } catch {
                    echo "âŒ ç”Ÿæˆæ›´æ–°æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯: $($_.Exception.Message)"
                    echo "é”™è¯¯è¯¦æƒ…: $($_.Exception)"
                    exit 1
                  }

                  echo "âœ… æ›´æ–°æ—¥å¿—ç”Ÿæˆå®Œæˆ"
                  
                  # æ·»åŠ è°ƒè¯•ä¿¡æ¯è¾“å‡º
                  echo "=== è°ƒè¯•ä¿¡æ¯ ==="
                  echo "ç‰ˆæœ¬: $version"
                  echo "æ ‡ç­¾: $tagName"
                  echo "ä¸Šä¸€ä¸ªæ ‡ç­¾: $previousTag"
                  echo "é‡å¤ç‰ˆæœ¬: $isRepeatVersion"
                  echo "å†…å®¹é•¿åº¦: $($changelogContent.Length)"
                  echo "æœ€ç»ˆæ—¥å¿—é•¿åº¦: $($finalChangelog.Length)"
                  echo "=== ç»“æŸè°ƒè¯• ==="
                  
                  # ç¡®ä¿æˆåŠŸé€€å‡º
                  exit 0

            # å¯é€‰ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹Actionç”Ÿæˆæ›´ä¸“ä¸šçš„æ›´æ–°æ—¥å¿—
            - name: Generate Release Notes with GitHub API
              if: false # è®¾ç½®ä¸º true å¯ç”¨æ­¤åŠŸèƒ½
              id: release_notes
              uses: mikepenz/release-changelog-builder-action@v4
              with:
                  configuration: |
                      {
                        "categories": [
                          {
                            "title": "## ğŸš€ æ–°åŠŸèƒ½",
                            "labels": ["feature", "enhancement"]
                          },
                          {
                            "title": "## ğŸ› Bugä¿®å¤", 
                            "labels": ["bug", "fix"]
                          },
                          {
                            "title": "## ğŸ“– æ–‡æ¡£æ›´æ–°",
                            "labels": ["documentation", "docs"]
                          },
                          {
                            "title": "## ğŸ”§ å…¶ä»–æ›´æ–°",
                            "labels": []
                          }
                        ],
                        "ignore_labels": ["ignore"],
                        "sort": "ASC",
                        "template": "#{{CHANGELOG}}\n\n**å®Œæ•´æ›´æ–°**: #{{UNCATEGORIZED}}"
                      }
                  fromTag: ${{ github.event.before }}
                  toTag: ${{ github.sha }}
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Release
              if: ${{ steps.version.outputs.is_tag_push == 'true' || github.event_name == 'workflow_dispatch' }}
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag_name }}
                  name: Remote Controls ${{ steps.version.outputs.tag_name }}
                  body: ${{ steps.changelog.outputs.changelog }}
                  draft: false
                  prerelease: false
                  files: |
                      installer/dist/RC-main.exe
                      installer/dist/RC-GUI.exe
                      installer/dist/RC-tray.exe
                      installer/dist/installer/Remote-Controls-Installer-${{ steps.version.outputs.version }}.exe
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Summary
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'

                  echo "=== æ„å»ºæ€»ç»“ ==="
                  echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
                  echo "æ ‡ç­¾: ${{ steps.version.outputs.tag_name }}"
                  echo "Python: ${{ env.PYTHON_VERSION }}"
                  echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
                  if ("${{ github.event_name }}" -eq "push") {
                    echo "æ ‡ç­¾æ¨é€: ${{ github.ref_name }}"
                  } else {
                    echo "æ‰‹åŠ¨è§¦å‘: ${{ github.event.inputs.version }}"
                  }
                  echo "æ„å»ºå®Œæˆ âœ…"
