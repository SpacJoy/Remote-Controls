# @format

name: Build and Release Remote Controls

on:
    # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ V2.2.8ï¼‰
    push:
        tags:
            - "V*"

    # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆç”¨äºæµ‹è¯•ï¼‰
    workflow_dispatch:
        inputs:
            version:
                description: "ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š2.2.8ï¼‰"
                required: true
                default: "2.2.8"
                type: string
            update_version_files:
                description: "æ˜¯å¦æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶"
                required: false
                default: true
                type: boolean

env:
    PYTHON_VERSION: "3.12.10"
    # è®¾ç½®UTF-8ç¼–ç ä»¥æ­£ç¡®å¤„ç†ä¸­æ–‡å­—ç¬¦
    PYTHONIOENCODING: "utf-8"
    PYTHONUTF8: "1"

jobs:
    build-and-release:
        runs-on: windows-latest
        permissions:
            contents: write
            actions: read
            issues: read
            pull-requests: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Extract version from tag or input
              id: version
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  if ("${{ github.event_name }}" -eq "push") {
                    # ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ V å‰ç¼€ï¼‰
                    $tagName = "${{ github.ref_name }}"
                    $version = $tagName -replace '^V', ''
                    echo "version=$version" >> $env:GITHUB_OUTPUT
                    echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
                    echo "is_tag_push=true" >> $env:GITHUB_OUTPUT
                  } else {
                    # æ‰‹åŠ¨è§¦å‘ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
                    $version = "${{ github.event.inputs.version }}"
                    $tagName = "V$version"
                    echo "version=$version" >> $env:GITHUB_OUTPUT
                    echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
                    echo "is_tag_push=false" >> $env:GITHUB_OUTPUT
                  }
                  echo "æ„å»ºç‰ˆæœ¬: $version"
                  echo "æ ‡ç­¾åç§°: $tagName"

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Create virtual environment
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  python -m venv .venv
                  .\.venv\Scripts\Activate.ps1
                  python -m pip install --upgrade pip setuptools wheel

            - name: Install dependencies
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  .\.venv\Scripts\Activate.ps1
                  pip install -r requirements.txt
                  pip install pyinstaller>=6.13.0
                  # pip install nuitka>=2.7.12 zstandard>=0.24.0  # å·²ç¦ç”¨Nuitkaæ„å»º
                  
                  # éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
                  echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
                  python -c "import pystray; print('pystray version:', pystray.__version__)"
                  python -c "import tkinter; print('tkinter: OK')"
                  python -c "import requests; print('requests: OK')"
                  python -c "import psutil; print('psutil: OK')"
                  pip list | Select-String -Pattern "pystray|tkinter|requests|psutil|Pillow"

            - name: Update version files
              if: ${{ github.event.inputs.update_version_files == 'true' || github.event_name == 'push' }}
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
                  LC_ALL: en_US.UTF-8
                  LANG: en_US.UTF-8
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"
                  
                  .\.venv\Scripts\Activate.ps1
                  $version = "${{ steps.version.outputs.version }}"
                  
                  # æ‰§è¡Œå‰å†æ¬¡ç¡®è®¤ç¼–ç è®¾ç½®
                  python -c "import sys; print('Python encoding:', sys.stdout.encoding)"
                  
                  python installer/update_version.py $version
                  echo "ç‰ˆæœ¬æ–‡ä»¶å·²æ›´æ–°åˆ°: $version"

            - name: Test source files
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"
                  
                  .\.venv\Scripts\Activate.ps1
                  
                  echo "=== æµ‹è¯•æºæ–‡ä»¶å¯¼å…¥ ==="
                  # æµ‹è¯•ä¸»è¦æ¨¡å—èƒ½å¦æ­£å¸¸å¯¼å…¥
                  python -c "import sys; sys.path.insert(0, '.'); import tray; print('tray.py: OK')" || echo "tray.py: FAILED"
                  python -c "import sys; sys.path.insert(0, '.'); import GUI; print('GUI.py: OK')" || echo "GUI.py: FAILED"  
                  python -c "import sys; sys.path.insert(0, '.'); import main; print('main.py: OK')" || echo "main.py: FAILED"

            - name: Build with PyInstaller
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
                  LC_ALL: en_US.UTF-8
                  LANG: en_US.UTF-8
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"
                  
                  .\.venv\Scripts\Activate.ps1
                  $version = "${{ steps.version.outputs.version }}"

                  # è¿è¡ŒPyInstalleræ„å»ºè„šæœ¬
                  pwsh -NoProfile -ExecutionPolicy Bypass -File installer/build_installer.ps1 $version

                  echo "PyInstalleræ„å»ºå®Œæˆ"
                  if (Test-Path "installer/dist") {
                    Get-ChildItem -Path "installer/dist" -Recurse | ForEach-Object { echo $_.FullName }
                  }

            - name: Build with Nuitka (backup)
              if: false # ç¦ç”¨Nuitkaæ„å»ºï¼Œä»…ä½¿ç”¨PyInstaller
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
                  LC_ALL: en_US.UTF-8
                  LANG: en_US.UTF-8
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  # æ˜¾å¼è®¾ç½®Pythonç¯å¢ƒå˜é‡
                  $env:PYTHONIOENCODING = "utf-8"
                  $env:PYTHONUTF8 = "1"
                  
                  .\.venv\Scripts\Activate.ps1
                  $version = "${{ steps.version.outputs.version }}"

                  # è¿è¡ŒNuitkaæ„å»ºè„šæœ¬ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
                  try {
                    pwsh -NoProfile -ExecutionPolicy Bypass -File installer/build_nuitka.ps1 $version
                    echo "Nuitkaæ„å»ºå®Œæˆ"
                  } catch {
                    echo "Nuitkaæ„å»ºå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨PyInstallerç‰ˆæœ¬: $_"
                  }

            - name: List build artifacts
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
                  if (Test-Path "installer/dist") {
                    echo "EXEæ–‡ä»¶:"
                    Get-ChildItem -Path "installer/dist" -Filter "*.exe" | ForEach-Object { 
                      echo "  $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
                    }
                    
                    echo "å®‰è£…åŒ…:"
                    Get-ChildItem -Path "installer/dist/installer" -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
                      echo "  $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
                    }
                  }

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: remote-controls-v${{ steps.version.outputs.version }}
                  path: |
                      installer/dist/*.exe
                      installer/dist/installer/*.exe
                  retention-days: 90

            - name: Generate changelog
              id: changelog
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  $version = "${{ steps.version.outputs.version }}"
                  $tagName = "${{ steps.version.outputs.tag_name }}"

                  # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
                  $previousTag = ""
                  try {
                    $tags = git tag --sort=-version:refname | Select-Object -First 2
                    if ($tags.Count -gt 1) {
                      $previousTag = $tags[1]
                    } else {
                      $previousTag = git rev-list --max-parents=0 HEAD
                    }
                  } catch {
                    $previousTag = "HEAD~10"
                  }

                  echo "å½“å‰æ ‡ç­¾: $tagName"
                  echo "ä¸Šä¸€ä¸ªæ ‡ç­¾: $previousTag"

                  # ç”Ÿæˆcommitæ—¥å¿—
                  $commitLog = ""
                  if ($previousTag -ne "") {
                    $commits = git log --pretty=format:"- %s (%h)" "$previousTag..HEAD" | Where-Object { $_ -ne "" }
                    if ($commits) {
                      $commitLog = $commits -join "`n"
                    }
                  }

                  # å¦‚æœæ²¡æœ‰commitå˜æ›´ï¼Œæ·»åŠ é»˜è®¤è¯´æ˜
                  if (-not $commitLog) {
                    $commitLog = "- ç‰ˆæœ¬å‘å¸ƒå’Œæ„å»ºä¼˜åŒ–"
                  }

                  # ç”Ÿæˆæ›´æ–°æ—¥å¿—å†…å®¹
                  $changelog = @"
                  ## Remote Controls $tagName

                  **è‡ªåŠ¨æ„å»ºå‘å¸ƒ** - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC

                  ### ğŸ“¦ æ„å»ºä¿¡æ¯
                  - **Pythonç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}
                  - **æ„å»ºç¯å¢ƒ**: Windows (GitHub Actions)
                  - **æ„å»ºID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  - **æäº¤SHA**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

                  ### ğŸ¯ åŒ…å«æ–‡ä»¶
                  - \`RC-main.exe\` - ä¸»ç¨‹åº
                  - \`RC-GUI.exe\` - å›¾å½¢ç•Œé¢ç¨‹åº  
                  - \`RC-tray.exe\` - ç³»ç»Ÿæ‰˜ç›˜ç¨‹åº
                  - \`Remote-Controls-Installer-$version.exe\` - å®Œæ•´å®‰è£…åŒ…

                  ### ğŸ“‹ å®‰è£…è¯´æ˜
                  1. **æ¨èæ–¹å¼**: ä¸‹è½½å¹¶è¿è¡Œå®‰è£…åŒ… \`Remote-Controls-Installer-$version.exe\`
                  2. **æ‰‹åŠ¨æ–¹å¼**: ä¸‹è½½å•ç‹¬çš„EXEæ–‡ä»¶æ”¾åˆ°ä»»æ„ç›®å½•ä½¿ç”¨
                  3. **ç³»ç»Ÿè¦æ±‚**: Windows 10/11ï¼Œå»ºè®®ä½¿ç”¨ç®¡ç†å‘˜æƒé™è¿è¡Œ

                  ### ğŸ”„ æ›´æ–°å†…å®¹
                  $commitLog

                  ### ğŸ“š ç›¸å…³é“¾æ¥
                  - [ğŸ“– README.md](https://github.com/${{ github.repository }}/blob/main/README.md) - è¯¦ç»†ä½¿ç”¨è¯´æ˜
                  - [ğŸ“ æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/up.md) - å®Œæ•´ç‰ˆæœ¬å†å²
                  - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues) - BugæŠ¥å‘Šå’ŒåŠŸèƒ½å»ºè®®
                  - [ğŸ’¬ è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions) - ç¤¾åŒºè®¨è®º

                  ### âš ï¸ æ³¨æ„äº‹é¡¹
                  - é¦–æ¬¡ä½¿ç”¨è¯·è¿è¡ŒGUIç¨‹åºç”Ÿæˆé…ç½®æ–‡ä»¶
                  - æ‰˜ç›˜ç¨‹åºéœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æ­£å¸¸æ§åˆ¶ç³»ç»Ÿ
                  - å¦‚éœ€å¼€æœºè‡ªå¯ï¼Œå»ºè®®ä½¿ç”¨å®‰è£…åŒ…è‡ªå¸¦çš„è®¡åˆ’ä»»åŠ¡åŠŸèƒ½

                  ---

                  **å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£å’Œä½¿ç”¨æ•™ç¨‹è¯·æŸ¥çœ‹é¡¹ç›®ä¸»é¡µã€‚**
                  "@

                  # å°†å†…å®¹å†™å…¥GitHubè¾“å‡ºï¼ˆå¤„ç†å¤šè¡Œå†…å®¹ï¼‰
                  $delimiter = "EOF$(Get-Random)"
                  echo "changelog<<$delimiter" >> $env:GITHUB_OUTPUT
                  echo $changelog >> $env:GITHUB_OUTPUT
                  echo $delimiter >> $env:GITHUB_OUTPUT

                  echo "æ›´æ–°æ—¥å¿—ç”Ÿæˆå®Œæˆ"

            # å¯é€‰ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹Actionç”Ÿæˆæ›´ä¸“ä¸šçš„æ›´æ–°æ—¥å¿—
            - name: Generate Release Notes with GitHub API
              if: false # è®¾ç½®ä¸º true å¯ç”¨æ­¤åŠŸèƒ½
              id: release_notes
              uses: mikepenz/release-changelog-builder-action@v4
              with:
                  configuration: |
                      {
                        "categories": [
                          {
                            "title": "## ğŸš€ æ–°åŠŸèƒ½",
                            "labels": ["feature", "enhancement"]
                          },
                          {
                            "title": "## ğŸ› Bugä¿®å¤", 
                            "labels": ["bug", "fix"]
                          },
                          {
                            "title": "## ğŸ“– æ–‡æ¡£æ›´æ–°",
                            "labels": ["documentation", "docs"]
                          },
                          {
                            "title": "## ğŸ”§ å…¶ä»–æ›´æ–°",
                            "labels": []
                          }
                        ],
                        "ignore_labels": ["ignore"],
                        "sort": "ASC",
                        "template": "#{{CHANGELOG}}\n\n**å®Œæ•´æ›´æ–°**: #{{UNCATEGORIZED}}"
                      }
                  fromTag: ${{ github.event.before }}
                  toTag: ${{ github.sha }}
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Release
              if: ${{ steps.version.outputs.is_tag_push == 'true' || github.event_name == 'workflow_dispatch' }}
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag_name }}
                  name: Remote Controls ${{ steps.version.outputs.tag_name }}
                  body: ${{ steps.changelog.outputs.changelog }}
                  draft: false
                  prerelease: false
                  files: |
                      installer/dist/RC-main.exe
                      installer/dist/RC-GUI.exe
                      installer/dist/RC-tray.exe
                      installer/dist/installer/Remote-Controls-Installer-${{ steps.version.outputs.version }}.exe
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Summary
              shell: pwsh
              env:
                  PYTHONIOENCODING: utf-8
                  PYTHONUTF8: 1
              run: |
                  # è®¾ç½®PowerShellè¾“å‡ºç¼–ç ä¸ºUTF-8
                  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
                  $PSDefaultParameterValues['*:Encoding'] = 'utf8'
                  
                  echo "=== æ„å»ºæ€»ç»“ ==="
                  echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
                  echo "æ ‡ç­¾: ${{ steps.version.outputs.tag_name }}"
                  echo "Python: ${{ env.PYTHON_VERSION }}"
                  echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
                  if ("${{ github.event_name }}" -eq "push") {
                    echo "æ ‡ç­¾æ¨é€: ${{ github.ref_name }}"
                  } else {
                    echo "æ‰‹åŠ¨è§¦å‘: ${{ github.event.inputs.version }}"
                  }
                  echo "æ„å»ºå®Œæˆ âœ…"
